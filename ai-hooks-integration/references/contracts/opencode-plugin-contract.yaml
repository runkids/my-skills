name: opencode-plugin
version: "2.1"
runtime: bun

# Critical: Plugin must export a function, not an object
export_format: |
  export const PluginName = async ({ project, client, $, directory, worktree }) => {
    return { /* hooks */ };
  };

plugin_locations:
  project: ".opencode/plugins/"
  global: "~/.config/opencode/plugins/"
  npm: "opencode.json plugin array"

context:
  project: object       # Current project info
  client: object        # OpenCode SDK client
  $: function           # Bun shell API (for commands)
  directory: string     # Current working directory
  worktree: string      # Git worktree path

hooks:
  # Tool execution hooks
  tool.execute.before:
    input:
      tool: string        # Tool name (e.g., "bash", "read", "write")
      sessionID: string   # Session identifier
      callID: string      # Unique call identifier
    output:
      args: any           # Tool arguments (mutable)
    behavior:
      - return to allow
      - throw Error to block

  tool.execute.after:
    input:
      tool: string
      sessionID: string
      callID: string
    output:
      title: string       # Execution title
      output: string      # Tool output text
      metadata: any       # Additional metadata
    behavior:
      - return to complete
      - can log or send events

  # Command execution hook
  command.execute.before:
    input:
      command: string
      sessionID: string
    output:
      args: any
    behavior:
      - return to allow
      - throw Error to block

  # Chat hooks
  chat.message:
    input:
      message: object
    output:
      message: object     # Mutable

  chat.params:
    input:
      params: object
    output:
      params: object      # Mutable

  chat.headers:
    input:
      model: object
    output:
      headers: object     # Mutable (add custom headers)

  # Permission hook
  permission.ask:
    input:
      permission: object
    output:
      decision: string    # "allow" | "deny" | "ask"

  # Event hook (passive listener for all events)
  event:
    input:
      event: object       # Event payload with type property
    event_types:
      - session.created
      - session.idle
      - session.compacted
      - session.deleted
      - session.updated
      - file.edited
      - file.watcher.updated
      - command.executed
    behavior:
      - passive listener
      - cannot block
      - use for notifications, logging

  # Config hook
  config:
    input: object         # Config object
    behavior:
      - modify config in place

  # Custom tool definition
  tool:
    type: object
    structure:
      toolName:
        description: string
        args: object      # JSON schema for arguments
        execute: function # async (args) => string

  # Experimental hooks
  experimental.chat.messages.transform:
    input:
      messages: array
    output:
      messages: array     # Mutable

  experimental.chat.system.transform:
    input:
      system: string
    output:
      system: string      # Mutable

  experimental.session.compacting:
    input:
      session: object
    output:
      messages: array     # Mutable

  experimental.text.complete:
    input:
      text: string
    output:
      completions: array  # Mutable

common_errors:
  - error: "fn is not a function"
    cause: "Plugin exports an object instead of a function"
    fix: "Change `module.exports = { ... }` to `module.exports = async function(input) { return { ... }; }`"

  - error: "Cannot read property 'name' of undefined"
    cause: "Accessing context.tool.name instead of input.tool"
    fix: "Use input.tool directly (it's a string, not an object)"

  - error: "sessionId undefined"
    cause: "Using sessionId instead of sessionID (camelCase)"
    fix: "Use input.sessionID (capital ID)"

notes:
  - Plugin must export a function that returns Hooks object
  - OpenCode uses Bun runtime (ESM and CommonJS supported)
  - Hook functions receive (input, output) parameters
  - Mutate output object to modify behavior
  - Throw Error to block in "before" hooks
