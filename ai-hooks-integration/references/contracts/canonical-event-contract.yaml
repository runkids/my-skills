# Canonical Event Contract
# Normalized event format for cross-tool hook processing

name: canonical-event
version: "1.0"
description: |
  Unified event format that normalizes payloads from different AI tools
  (Claude, Gemini, Cursor, OpenCode) into a consistent structure.

# Input: Various tool-specific formats
# Output: Normalized canonical event

input_formats:
  claude:
    fields:
      - tool_name: string
      - tool_input: object
      - cwd: string
      - session_id: string
      - timestamp: string (ISO 8601)

  gemini:
    fields:
      - tool: string (maps to tool_name)
      - args: object (maps to tool_input)
      - working_directory: string (maps to cwd)
      - session_id: string

  cursor:
    fields:
      - command: string (in args.command)
      - cwd: string

  opencode:
    fields:
      - tool: string (maps to tool_name)
      - sessionID: string (note camelCase, maps to session_id)
      - callID: string
      - args: object (maps to tool_input)

output:
  canonical_event:
    event_type:
      type: string
      enum: [PreToolUse, PostToolUse, SessionStart, SessionEnd, Stop]
      description: Type of hook event

    source:
      type: string
      enum: [claude, gemini, cursor, opencode, windsurf, zed]
      description: |
        Detected source tool. This is determined by walking the process tree,
        NOT by trusting the claimed --source parameter.

    session_id:
      type: string
      description: Unique session identifier (may be empty for some tools)

    cwd:
      type: string
      description: Current working directory

    tool_name:
      type: string
      description: Name of the tool being invoked
      examples: [Bash, Write, Edit, Read, Grep, Glob]

    tool_input:
      type: object
      description: Input parameters for the tool (varies by tool_name)

    timestamp:
      type: string
      format: date-time
      description: ISO 8601 timestamp (may be empty)

    raw_payload:
      type: object
      description: Original unmodified payload for debugging

# Field mapping reference
field_mappings:
  tool_name:
    claude: tool_name
    gemini: tool
    cursor: (extracted from context)
    opencode: tool

  tool_input:
    claude: tool_input
    gemini: args
    cursor: args
    opencode: args

  cwd:
    claude: cwd
    gemini: working_directory
    cursor: cwd
    opencode: (in tool input or context)

  session_id:
    claude: session_id
    gemini: session_id
    cursor: (not available)
    opencode: sessionID

# Usage example
example_transformation:
  input: |
    # Claude PreToolUse payload
    {
      "tool_name": "Bash",
      "tool_input": {"command": "npm test"},
      "cwd": "/Users/user/project",
      "session_id": "abc123",
      "timestamp": "2025-01-15T10:30:00Z"
    }

  output: |
    # Canonical event
    {
      "event_type": "PreToolUse",
      "source": "claude",        # Detected, not claimed
      "session_id": "abc123",
      "cwd": "/Users/user/project",
      "tool_name": "Bash",
      "tool_input": {"command": "npm test"},
      "timestamp": "2025-01-15T10:30:00Z",
      "raw_payload": { ... original ... }
    }

# Response format (for PreToolUse events)
response:
  allow:
    hookSpecificOutput:
      permissionDecision: allow
    continue: true

  deny:
    hookSpecificOutput:
      permissionDecision: deny
      permissionDecisionReason: "string explaining why"
    continue: false

  ask:
    hookSpecificOutput:
      permissionDecision: ask
      permissionDecisionReason: "string asking user to confirm"
    continue: true

  modify:
    hookSpecificOutput:
      permissionDecision: allow
      modifiedToolInput:
        # Modified tool input to use instead
        command: "modified command"
    continue: true
